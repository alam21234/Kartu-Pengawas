<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Generator Kartu Pengawas (A6)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f3f4f6;--card:#fff;--accent1:#4b9be6;--accent2:#7fb9ff}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:18px;background:var(--bg);color:#072039}
  .container{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,.07)}
  h1{margin:0 0 12px;font-size:20px}
  label{display:block;margin-top:10px;font-weight:600}
  input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8}
  button{margin-top:12px;padding:10px 14px;border:0;border-radius:8px;background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(75,155,230,.18)}
  small{color:#556}
  #status{margin-top:10px;color:#333}
  .previewGrid{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
  .cardPreview{width:210px;height:148px;border-radius:6px;overflow:hidden;border:1px solid #e6eef8;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .searchBox{display:flex;gap:8px;margin-top:12px}
  #nameInput{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8}
  .muted{color:#667; font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h1>Generator Kartu Pengawas — A6</h1>
  <p class="muted">Masukkan link Google Sheets (CSV) jadwal. Guru bisa ketik nama lalu unduh kartu mereka sendiri; admin dapat generate semua kartu.</p>

  <label>Link CSV publik Google Sheets:</label>
  <input id="csvUrl" type="text" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vStwIDEQx4PflOeIxaBZunj0DdFxWP_0T-w9TLrVLm_XoPwHDPhKEHRYMUyl2PaUkq5q__yrENag5Xm/pub?gid=1434741519&single=true&output=csv"/>

  <label>Logo path (relatif ke file HTML atau URL):</label>
  <input id="logoPath" type="text" value="/mnt/data/SMAN1Cluring-emblem.png"/>

  <div class="controls">
    <select id="qrMode">
      <option value="unique">QR unik per pengawas (kode teks)</option>
      <option value="form">QR → Google Form (global)</option>
      <option value="none">Tidak pakai QR</option>
    </select>
    <button id="loadBtn">Load Jadwal</button>
    <button id="genAllBtn">Generate Semua Kartu (ZIP)</button>
  </div>

  <div class="searchBox">
    <input id="nameInput" placeholder="Ketik nama Anda (contoh: puji rahayu)" />
    <button id="generateSingle">Cari & Unduh Kartu Saya</button>
  </div>

  <div id="status"></div>

  <h3>Preview (6 kartu pertama)</h3>
  <div id="preview" class="previewGrid"></div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/* ======= CONFIG ======= */
const supervisorsList = {
1:"Moh. Arif Susiawan, S.Pd",2:"Drs. Makhrus",3:"Moh. Suharso, S.Pd",4:"Umiasih, S. Pd",
5:"Dra. Subekti Rahayu",6:"Dra. Siti Rofiah",7:"Drs. Sumardami",8:"Drs. Misnan",
9:"Drs. Bagus Dwi Suasono",10:"Agus Supriyadi, S.Pd",11:"Dra Sirkah Muawanah, S.Pd",12:"Lilik Istyowati, S.T",
13:"Drs. Puji Rahayu",14:"Endry Ernaningtyas, S.Pd",15:"Dra. Sih Puspitaning",16:"Ali Muthohar, S.Pd",
17:"Imam Afandi, S.Pd",18:"Drs. Suroso",19:"Drs. SY. Hadi",20:"Magiyono, M.Pd",
21:"Mirza Prastyo, S.Pd",22:"Ritwan Junianto, S.Pd",23:"Rio Bagus Dirgantara, S.Pd",24:"Adha Q Muttawakillah, S.Pd",
25:"Wirdah Pramita, S.Pd",26:"Titin Nursanti, S.Pd",27:"Cahya Mahardika, S.Pd",28:"Kristin Setiyowati, S.Kom",
29:"Joko Irawan, S.Pd",30:"Dewi Ainur Rokhmah, S.Pd.I",31:"Imam Hadi Taufik H, S.Pd.I",32:"Shienda Setyawatie, S.Pd",
33:"Dwi Indah Lestari, S.Pd",34:"Aris Riyanto, S.Pd",35:"Rini Asih, S.Pd",36:"Yuli Fitriani, S.E",
37:"Muhammad As'adi, S.S.",38:"Tina Wahyu Lestari, S.Pd.",39:"Galih Kidung Wobowo, S.Sn.",40:"Andis Dwi Saputro, S.Sos.I",
41:"Yunita Firmaningtyas, S.Pd.",42:"Agus Winaryanto, S.Pd.H",43:"Wiyanto, S.Pd",44:"Silvi Maharani Hilda, S.Pd"
};
/* ======================= */

const { jsPDF } = window.jspdf;
let scheduleData = []; // array of objects
let assignments = {}; // id -> array of {hari,tanggal,waktu,roomPos}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean);
  const rows = lines.map(line=>{
    const cols=[]; let cur=''; let inquote=false;
    for (let ch of line){
      if (ch === '"'){ inquote = !inquote; continue; }
      if (ch === ',' && !inquote){ cols.push(cur); cur=''; } else cur+=ch;
    }
    cols.push(cur);
    return cols.map(c=>c.trim());
  });
  return rows;
}

function rowsToObjects(rows){
  if(!rows||rows.length<1) return [];
  const header = rows[0].map(h=>h.replace(/\uFEFF/g,'').trim());
  return rows.slice(1).map(r=>{
    const obj={};
    header.forEach((h,i)=> obj[h||('C'+i)] = r[i]||'');
    return obj;
  });
}

function buildAssignments(data){
  const out={};
  data.forEach(row=>{
    const hariTanggal = row['Hari/Tanggal'] || row['Hari'] || row['Tanggal'] || '';
    const waktu = row['Waktu'] || '';
    Object.keys(row).forEach(k=>{
      const kk = k.trim();
      if(['No','Hari/Tanggal','Hari','Tanggal','Waktu','ISTIRAHAT','RUANG','CAD'].includes(kk)) return;
      if(!/^R?\d{1,2}$/.test(kk) && !/^\d{1,2}$/.test(kk)) return;
      const val = row[k];
      if(!val) return;
      const id = String(val).trim();
      if(!out[id]) out[id]=[];
      out[id].push({hari:hariTanggal, waktu:waktu, roomPos: kk.replace(/^R/,'')});
    });
  });
  return out;
}

async function loadCSV(csvUrl){
  document.getElementById('status').textContent = 'Mengambil CSV...';
  const r = await fetch(csvUrl);
  const txt = await r.text();
  const rows = parseCSV(txt);
  const objs = rowsToObjects(rows);
  scheduleData = objs;
  assignments = buildAssignments(objs);
  document.getElementById('status').textContent = `Selesai muat jadwal — baris: ${objs.length}`;
  renderPreview();
}

function renderPreview(){
  const preview = document.getElementById('preview');
  preview.innerHTML='';
  let count=0;
  for (const id in assignments){
    if (count>=6) break;
    const name = supervisorsList[id] || ('ID '+id);
    const canvas = makeCardCanvas({name, id, assign: assignments[id], logoSrc: document.getElementById('logoPath').value});
    const img = new Image(); img.src = canvas.toDataURL('image/png'); img.style.width='100%';
    const wrapper = document.createElement('div'); wrapper.className='cardPreview'; wrapper.appendChild(img);
    preview.appendChild(wrapper);
    count++;
  }
}

function makeCardCanvas({name,id,assign,logoSrc,qrText}){
  const mmToPx = mm => Math.round(mm * (96/25.4));
  const W = mmToPx(105), H = mmToPx(148);
  const cv = document.createElement('canvas'); cv.width=W; cv.height=H;
  const ctx = cv.getContext('2d');
  // background gradient
  const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#f6fbff'); g.addColorStop(1,'#def0ff');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  // subtle panel
  ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.fillRect(12,12,W-24,H-24);
  // logo (synchronous draw if cached image)
  const img = new Image(); img.crossOrigin='anonymous'; img.src = logoSrc;
  img.onload = ()=>{ ctx.drawImage(img, W/2-36, 20, 72,72); };
  // title
  ctx.fillStyle='#013049'; ctx.font='600 14px Inter, Arial'; ctx.textAlign='center';
  ctx.fillText('KARTU PENGAWAS UJIAN', W/2, 110);
  // name
  ctx.textAlign='left'; ctx.font='600 12px Inter, Arial';
  ctx.fillText('Nama: ' + name, 22, 135);
  ctx.font='500 11px Inter, Arial'; ctx.fillText('ID: ' + id, 22, 152);
  // jadwal list
  ctx.font='400 10px Inter, Arial'; let y=170;
  if(assign && assign.length){
    assign.slice(0,8).forEach(a=>{
      ctx.fillText(`- ${a.hari} | ${a.waktu} | Ruang ${a.roomPos}`, 22, y); y+=14;
    });
  } else { ctx.fillText('- (tidak ada tugas)', 22, y); y+=14; }
  // QR placeholder (draw later by caller)
  ctx.fillStyle='#fff'; ctx.fillRect(W-112, H-112, 90,90); ctx.strokeStyle='#cfd8e3'; ctx.strokeRect(W-112, H-112, 90, 90);
  return cv;
}

function makeQRDataURL(text, size=200){
  const qr = new QRious({value:text, size:size}); return qr.toDataURL('image/png');
}

async function generateSingleByName(nameQuery){
  const name = nameQuery.trim().toLowerCase();
  // find id by partial match in supervisorsList
  const matches = Object.entries(supervisorsList).filter(([id,nm])=> nm.toLowerCase().includes(name));
  if(matches.length === 0) { alert('Nama tidak ditemukan. Coba ketik sebagian nama (mis: puji rahayu)'); return; }
  // if multiple, pick first (could be extended)
  const [id, nm] = matches[0];
  const assign = assignments[id] || [];
  // build canvas and add QR
  const canvas = makeCardCanvas({name:nm, id, assign, logoSrc: document.getElementById('logoPath').value});
  const qrMode = document.getElementById('qrMode').value;
  let qrText = '';
  if (qrMode === 'unique') {
    qrText = `PENGAWAS|ID:${id}|NAMA:${nm}|`;
    assign.forEach(a=> qrText += `${a.hari} ${a.waktu} R${a.roomPos};`);
  } else if (qrMode === 'form') {
    qrText = 'https://forms.gle/REPLACE_WITH_YOUR_FORM?pengawas=' + encodeURIComponent(nm);
  }
  if (qrText){
    const ctx = canvas.getContext('2d');
    const imgQR = new Image(); imgQR.src = makeQRDataURL(qrText, 250);
    await new Promise(r=>imgQR.onload=r);
    ctx.drawImage(imgQR, canvas.width - 110, canvas.height - 110, 90, 90);
  }
  // create PDF A6
  const pdf = new jsPDF({format:[105,148], unit:'mm'});
  pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 105, 148);
  pdf.save(`${nm.replace(/[\\/:"*?<>|]/g,'_')}_kartu_pengawas.pdf`);
}

async function generateAllZip(){
  const zip = new JSZip();
  const qrMode = document.getElementById('qrMode').value;
  document.getElementById('status').textContent = 'Membuat semua kartu...';
  for (let id=1; id<=44; id++){
    const name = supervisorsList[id] || ('ID '+id);
    const assign = assignments[id] || [];
    const canvas = makeCardCanvas({name, id, assign, logoSrc: document.getElementById('logoPath').value});
    let qrText = '';
    if (qrMode === 'unique'){
      qrText = `PENGAWAS|ID:${id}|NAMA:${name}|`;
      assign.forEach(a=> qrText += `${a.hari} ${a.waktu} R${a.roomPos};`);
    } else if (qrMode === 'form'){
      qrText = 'https://forms.gle/REPLACE_WITH_YOUR_FORM?pengawas=' + encodeURIComponent(name);
    }
    if (qrText){
      const ctx = canvas.getContext('2d');
      const imgQR = new Image(); imgQR.src = makeQRDataURL(qrText,250);
      await new Promise(r=>imgQR.onload=r);
      ctx.drawImage(imgQR, canvas.width - 110, canvas.height - 110, 90, 90);
    }
    const pdf = new jsPDF({format:[105,148], unit:'mm'});
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 105, 148);
    const blob = pdf.output('blob');
    zip.file(`kartu_${String(id).padStart(2,'0')}_${name.replace(/[\\/:"*?<>|]/g,'_')}.pdf`, blob);
    document.getElementById('status').textContent = `Membuat kartu ${id}/44...`;
    // small throttle
    await new Promise(r=>setTimeout(r,25));
  }
  document.getElementById('status').textContent = 'Mengemas ZIP...';
  const content = await zip.generateAsync({type:'blob'});
  saveAs(content, 'kartu_pengawas_batch44.zip');
  document.getElementById('status').textContent = 'Selesai — ZIP diunduh.';
}

/* UI hooks */
document.getElementById('loadBtn').addEventListener('click', ()=> loadCSV(document.getElementById('csvUrl').value));
document.getElementById('generateSingle').addEventListener('click', ()=> generateSingleByName(document.getElementById('nameInput').value));
document.getElementById('genAllBtn').addEventListener('click', generateAllZip);

/* auto-load default CSV */
window.addEventListener('load', ()=> {
  // try load default but silently fail if CORS blocks
  const url = document.getElementById('csvUrl').value;
  if (url) loadCSV(url).catch(()=> document.getElementById('status').textContent='Silakan klik Load Jadwal (CORS mungkin dibatasi oleh browser/Sheets).');
});
</script>
</body>
</html>
